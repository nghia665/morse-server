<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Luy·ªán Morse ‚Äî Chu·∫©n & ·ªîn ƒë·ªãnh</title>
  <style>
/* ======= PHONG C√ÅCH CAM - ƒêEN K·ª∏ NƒÇNG TR·∫∫ (T·ªîNG H·ª¢P 3 STYLE) ======= */
:root{
  --orange1:#ff7b00; /* cam t∆∞∆°i */
  --orange2:#ff5200; /* cam ƒë·∫≠m SAR */
  --orangeNeon:#ffa533; /* neon */
  --black:#0c0c0c;
  --gray:#1a1a1a;
  --card:#111;
  --border:#222;
}
body{
  font-family: 'Inter', sans-serif;
  background: var(--black);
  color:#eee;
  padding:20px;
}
.wrap{max-width:900px;margin:0 auto}

.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:10px;
  padding:20px;
  margin-bottom:20px;
  box-shadow:0 0 18px #0007;
}

h1,h3,h4{
  font-weight:800;
  text-transform:uppercase;
  letter-spacing:1px;
  background:linear-gradient(90deg,var(--orange2),var(--orangeNeon));
  -webkit-background-clip:text;
  color:transparent;
}

button{
  background:linear-gradient(90deg,var(--orange1),var(--orange2));
  border:none;
  color:#fff;
  padding:10px;
  border-radius:6px;
  cursor:pointer;
  font-weight:700;
  letter-spacing:0.5px;
  transition:0.15s;
}
button:hover{
  transform:scale(1.05);
  box-shadow:0 0 12px var(--orangeNeon);
}
button.small{
  background:#333;
  color:#ccc;
}
button.small:hover{
  background:#444;
}

input,select{
  width:100%;padding:12px;margin-top:8px;border-radius:6px;
  border:1px solid #333;
  background:#0f0f0f;
  color:#ffa;
  font-size:15px;
}
.row{display:flex;gap:12px}
.muted{color:#999;font-size:13px}
</style>
</head>
<body>
  <script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();
</script>

<div class="wrap">
  <div class="card">
    <h1>üî• Luy·ªán Morse ‚Äî Phi√™n b·∫£n ·ªîn ƒë·ªãnh</h1>
    
  </div>

  <div class="card" id="userLogin">
    <h3>Ng∆∞·ªùi d·ª± thi</h3>
    <input id="username" placeholder="T√™n c·ªßa b·∫°n..." />
    <div class="row">
      <button onclick="enterUser()">V√†o thi</button>
      <button class="small" onclick="showAdminLogin()">Admin</button>
    </div>
  </div>

  <div class="card" id="userPage" style="display:none">
    <h3 id="welcome">Xin ch√†o</h3>
    <p class="muted">Nghe Morse v√† nh·∫≠p b·∫°ch vƒÉn b·∫°n nghe ƒë∆∞·ª£c.</p>
    <input id="answerInput" placeholder="Nh·∫≠p ƒë√°p √°n..." />
    <div class="row">
      <button onclick="submitAnswer()">N·ªôp b√†i</button>
      <button class="small" onclick="userLogout()">Tho√°t</button>
    </div>
    <p id="result"></p>
  </div>

  <div class="card" id="adminLogin" style="display:none">
    <h3>ƒêƒÉng nh·∫≠p Admin</h3>
    <input type="password" id="adminPass" placeholder="M·∫≠t kh·∫©u admin" />
    <div class="row">
      <button onclick="checkAdmin()">ƒêƒÉng nh·∫≠p</button>
      <button class="small" onclick="cancelAdmin()">Quay l·∫°i</button>
    </div>
  </div>

  <div class="card" id="adminPanel" style="display:none">
    <h3>ADMIN</h3>
    <input id="morseText" placeholder="Nh·∫≠p b·∫°ch vƒÉn >= 5 k√Ω t·ª±" />
    <select id="speed">
      <option value="10">T·ªëc ƒë·ªô 10</option>
      <option value="7">T·ªëc ƒë·ªô 7</option>
      <option value="5">T·ªëc ƒë·ªô 5</option>
      <option value="3">T·ªëc ƒë·ªô 3</option>
    </select>

    <label class="muted" style="margin-top:8px;display:block;">H·ªá s·ªë tƒÉng t·ªëc (Admin)</label>
    <input id="speedBoost" type="number" value="1" min="1" max="5" step="1" />
    <div class="row">
      <button onclick="playMorse()">Ph√°t Morse</button>
      <button class="small" onclick="stopAll()" style="background:#a33">D·ª´ng</button>
    </div>

    <h4>Danh s√°ch ƒë√∫ng</h4>
    <div id="correctList" class="muted"></div>
    <button onclick="adminLogout()" class="small" style="margin-top:10px;background:#444">ƒêƒÉng xu·∫•t</button>
  </div>
</div>

<script>
// -------------------- DATA --------------------
const ADMIN_PASS = "205206";
let currentText = "";
let activeOscillators = [];
let correctList = JSON.parse(localStorage.getItem("correctList")||"[]");

function $(id){return document.getElementById(id)}

function escapeHtml(s){return s.replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]))}

function renderCorrect(){ $('correctList').innerHTML = correctList.length===0 ? "<i>Ch∆∞a ai tr·∫£ l·ªùi ƒë√∫ng.</i>" : correctList.map((n,i)=>`${i+1}. ${escapeHtml(n)}`).join('<br>'); }
renderCorrect();

// -------------------- ENTER KEY SUPPORT --------------------
// Nh·∫•n Enter t·∫°i √¥ t√™n ‚Üí V√†o thi
$("username").addEventListener('keypress', e=>{ if(e.key==='Enter') enterUser(); });
// Nh·∫•n Enter t·∫°i √¥ m·∫≠t kh·∫©u admin ‚Üí ƒêƒÉng nh·∫≠p
$("adminPass").addEventListener('keypress', e=>{ if(e.key==='Enter') checkAdmin(); });
// Nh·∫•n Enter t·∫°i √¥ nh·∫≠p ƒë√°p √°n ‚Üí N·ªôp b√†i
$("answerInput").addEventListener('keypress', e=>{ if(e.key==='Enter') submitAnswer(); });

// -------------------- USER --------------------
function enterUser(){
  const name = $('username').value.trim();
  if(!name) return alert("Nh·∫≠p t√™n!");
  localStorage.setItem('currentUser', name);
  $('userLogin').style.display='none';
  $('userPage').style.display='block';
  $('welcome').innerText = "Xin ch√†o, " + name;
}

function userLogout(){
  localStorage.removeItem('currentUser');
  $('userPage').style.display='none';
  $('userLogin').style.display='block';
}

function submitAnswer(){
  const ans = $('answerInput').value.trim().toLowerCase();
  if(!currentText) return alert("Admin ch∆∞a ph√°t Morse!");

  const user = localStorage.getItem("currentUser") || "Kh√°ch";

  if(ans === currentText.toLowerCase()){
    $('result').innerHTML = '‚úî Ch√≠nh x√°c!';
    if(!correctList.includes(user)) correctList.push(user);
    localStorage.setItem('correctList', JSON.stringify(correctList));
    renderCorrect();
  } else $('result').innerHTML = '‚ùå Sai r·ªìi!';
}

// -------------------- ADMIN --------------------
function showAdminLogin(){ $('userLogin').style.display='none'; $('adminLogin').style.display='block'; }
function cancelAdmin(){ $('adminLogin').style.display='none'; $('userLogin').style.display='block'; }
function checkAdmin(){ if($('adminPass').value===ADMIN_PASS){ $('adminPass').value=''; $('adminLogin').style.display='none'; $('adminPanel').style.display='block'; } else alert("Sai m·∫≠t kh·∫©u!"); }
function adminLogout(){ $('adminPanel').style.display='none'; $('userLogin').style.display='block'; }

// -------------------- MORSE --------------------
const MORSE_MAP = {
 a:'.-',b:'-...',c:'-.-.',d:'-..',e:'.',f:'..-.',g:'--.',h:'....',i:'..',j:'.---',k:'-.-',l:'.-..',m:'--',n:'-.',o:'---',p:'.--.',q:'--.-',r:'.-.',s:'...',t:'-',u:'..-',v:'...-',w:'.--',x:'-..-',y:'-.--',z:'--..',
 '0':'-----','1':'.----','2':'..---','3':'...--','4':'....-','5':'.....','6':'-....','7':'--...','8':'---..','9':'----.',
 '.':'.-.-.-', ',':'--..--', '?':'..--..', '!':'-.-.--', '/':'-..-.', '=':'-...-', '-':'-....-', '"':'.-..-.', '\'':'.----.',
 '&':'.-...', ':':'---...', ';':'-.-.-.', '(': '-.--.', ')':'-.--.-', ' ': null,
 "'": '...',    // s·∫Øc = s
 "`": '..-.',   // huy·ªÅn = f
 "?": '.-.',    // h·ªèi = r
 "~": '-..-',   // ng√£ = x
 ".": '.---'     // n·∫∑ng = j
};

function removeVietnamese(str){
  const telexMap = {
    '√°': "a'", '√†': 'a`', '·∫£': 'a?', '√£': 'a~', '·∫°': 'a.',
    '√¢': 'aa', '·∫•': "aa'", '·∫ß': 'aa`', '·∫©': 'aa?', '·∫´': 'aa~', '·∫≠': 'aa.',
    'ƒÉ': 'aw', '·∫Ø': "aw'", '·∫±': 'aw`', '·∫≥': 'aw?', '·∫µ': 'aw~', '·∫∑': 'aw.',
    '√©': "e'", '√®': 'e`', '·∫ª': 'e?', '·∫Ω': 'e~', '·∫π': 'e.',
    '√™': 'ee', '·∫ø': "ee'", '·ªÅ': 'ee`', '·ªÉ': 'ee?', '·ªÖ': 'ee~', '·ªá': 'ee.',
    '√≠': "i'", '√¨': 'i`', '·ªâ': 'i?', 'ƒ©': 'i~', '·ªã': 'i.',
    '√≥': "o'", '√≤': 'o`', '·ªè': 'o?', '√µ': 'o~', '·ªç': 'o.',
    '√¥': 'oo', '·ªë': "oo'", '·ªì': 'oo`', '·ªï': 'oo?', '·ªó': 'oo~', '·ªô': 'oo.',
    '∆°': 'ow', '·ªõ': "ow'", '·ªù': 'ow`', '·ªü': 'ow?', '·ª°': 'ow~', '·ª£': 'ow.',
    '√∫': "u'", '√π': 'u`', '·ªß': 'u?', '≈©': 'u~', '·ª•': 'u.',
    '∆∞': 'uw', '·ª©': "uw'", '·ª´': 'uw`', '·ª≠': 'uw?', '·ªØ': 'uw~', '·ª±': 'uw.',
    '√Ω': "y'", '·ª≥': 'y`', '·ª∑': 'y?', '·ªπ': 'y~', '·ªµ': 'y.',
    'ƒë': 'dd'
  };
  return str.replace(/[√°√†·∫£√£·∫°√¢·∫•·∫ß·∫©·∫´·∫≠ƒÉ·∫Ø·∫±·∫≥·∫µ·∫∑√©√®·∫ª·∫Ω·∫π√™·∫ø·ªÅ·ªÉ·ªÖ·ªá√≠√¨·ªâƒ©·ªã√≥√≤·ªè√µ·ªç√¥·ªë·ªì·ªï·ªó·ªô∆°·ªõ·ªù·ªü·ª°·ª£√∫√π·ªß≈©·ª•∆∞·ª©·ª´·ª≠·ªØ·ª±√Ω·ª≥·ª∑·ªπ·ªµƒë]/g,
    c => telexMap[c]
  );
}

function playMorse(){
  stopAll();
  currentText = $('morseText').value.trim();
  if(currentText.length < 5) return alert("B·∫°ch vƒÉn ph·∫£i >= 5 k√Ω t·ª±!");
// G·ª¨I L·ªÜNH PH√ÅT MORSE T·ªöI SERVER
socket.emit("adminPlayMorse", {
  text: currentText,
  speed: $('speed').value,
  boost: $('speedBoost').value
});

  let unit = {10:80,7:110,5:140,3:180}[$('speed').value];
  const boost = parseInt($('speedBoost').value) || 1;
  unit = Math.max(20, unit / boost);
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  if(ctx.state === 'suspended') ctx.resume();
  let t = ctx.currentTime + 0.03;

  const norm = removeVietnamese(currentText.toLowerCase());

  for(const ch of norm){
    const code = MORSE_MAP[ch];
    if(!code){ t += (unit*3)/1000; continue; }

    for(const mark of code){
      const dur = mark==='.' ? unit/1000 : (unit*3)/1000;

      const osc = ctx.createOscillator();
      osc.type='sine';
      osc.frequency.value=750; // √¢m chu·∫©n nh∆∞ web m·∫´u
      const gain = ctx.createGain();
      gain.gain.setValueAtTime(1, t);
      osc.connect(gain);
      gain.connect(ctx.destination);

      osc.start(t);
      osc.stop(t+dur);
      activeOscillators.push(osc);

      t += dur + unit/1000;
    }
    t += (unit*2)/1000;
  }
}

function stopAll(){ for(const o of activeOscillators){ try{o.stop()}catch(e){} } activeOscillators=[]; }
</script>
<script>
// Nh·∫≠n t√≠n hi·ªáu t·ª´ server ƒë·ªÉ ph√°t Morse
socket.on("playMorseForUsers", function(data){
  currentText = data.text;
  userPlayMorse(data);
});

// H√†m ph√°t Morse cho user (gi·ªëng admin)
function userPlayMorse(data){
  const { text, speed, boost } = data;

  let unit = {10:80,7:110,5:140,3:180}[speed];
  let finalSpeed = Math.max(20, unit / boost);

  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  let t = ctx.currentTime + 0.03;

  const norm = removeVietnamese(text.toLowerCase());

  for(const ch of norm){
    const code = MORSE_MAP[ch];
    if(!code){ 
      t += (finalSpeed * 3) / 1000; 
      continue; 
    }

    for(const mark of code){
      const dur = mark === '.' ? finalSpeed/1000 : (finalSpeed*3)/1000;

      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.frequency.value = 750;
      osc.connect(gain);
      gain.connect(ctx.destination);

      osc.start(t);
      osc.stop(t + dur);

      t += dur + finalSpeed/1000;
    }

    t += (finalSpeed * 2) / 1000;
  }
}
</script>

</body>
</html>
